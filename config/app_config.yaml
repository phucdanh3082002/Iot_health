ai:
  anomaly_detection:
    algorithm: IsolationForest
    enabled: true
    sensitivity: 0.1
  chatbot:
    enabled: false
    model_path: models/health_chatbot.tflite
  trend_analysis:
    enabled: true
    window_size: 24
app:
  debug: true
  log_level: INFO
  name: IoT Health Monitor
  version: 1.0.0
audio:
  alert_sound: config/alert.wav
  enabled: true
  fallback_engine: espeak
  locale: vi
  piper:
    assets_dir: asset/tts
    config_path: /home/pi/piper_models/vi_VN-vais1000-medium.onnx.json
    model_path: /home/pi/piper_models/vi_VN-vais1000-medium.onnx
    speaker: ''
    strict_assets: true
  tts_engine: piper
  voice_enabled: true
  volume: 80
communication:
  mqtt:
    # ============================================================
    # HiveMQ Cloud Broker (Production)
    # ============================================================
    broker: c8c0b20138314154b4f21f4c7d1e19a5.s1.eu.hivemq.cloud
    port: 8883  # TLS port (bắt buộc cho HiveMQ Cloud)
    websocket_port: 8884  # WebSocket port (cho web dashboard)
    keepalive: 60
    
    # Authentication (HiveMQ Cloud credentials)
    username: rpi_bp_001  # HiveMQ username cho Pi
    password_env: MQTT_PASSWORD  # Password từ environment variable (.env)
    password: ''  # KHÔNG điền password trực tiếp vào đây
    
    # Device identification
    device_id: rpi_bp_001  # Unique device ID
    
    # TLS/SSL Security (HiveMQ Cloud mặc định dùng TLS)
    use_tls: true
    # HiveMQ Cloud dùng Let's Encrypt CA (trusted by default)
    # Không cần cert files riêng, Python ssl module tự verify
    
    # QoS levels per message type
    qos:
      vitals: 1  # At least once delivery
      alerts: 2  # Exactly once delivery (critical)
      status: 0  # Fire and forget
      commands: 2  # Exactly once delivery
    
    # Reconnection settings
    reconnect_delay: 5
    max_reconnect_attempts: 10
    
    # Last Will & Testament (offline detection)
    last_will:
      topic: iot_health/device/{device_id}/status
      message: '{"device_id": "{device_id}", "status": "offline", "reason": "unexpected_disconnect"}'
      qos: 1
      retain: true
    
    # Topic templates (với placeholders)
    topics:
      vitals: iot_health/device/{device_id}/vitals
      alerts: iot_health/device/{device_id}/alerts
      status: iot_health/device/{device_id}/status
      commands: iot_health/patient/{patient_id}/commands
      predictions: iot_health/patient/{patient_id}/predictions
  
  rest_api:
    api_version: v1
    server_url: http://localhost:8000
    timeout: 5
    use_https: false
  
  store_forward:
    enabled: true
    max_queue_size: 1000
    max_retries: 5
    retry_interval: 30

# Cloud Synchronization (AWS RDS MySQL - Singapore)
cloud:
  enabled: true  # ✅ ENABLED - Syncing to AWS RDS
  
  # Device registration (for cloud database)
  device:
    device_id: "rpi_bp_001"  # ✅ Unique device identifier (IMPORTANT: Change per device)
    device_name: "Living Room Health Monitor"  # Human-readable name (sẽ bị overwrite bởi Android app)
    device_type: "blood_pressure_monitor"  # Device type
    location: "Home - Living Room"  # Physical location (sẽ bị overwrite bởi Android app)
    pairing_code: "ABC123XY"  # ✅ Pairing code cố định cho thiết bị này (dùng để pair với Android app)
    firmware_version: "1.0.0"  # Update when firmware changes
    os_version: "Raspberry Pi OS Bookworm 64-bit"  # OS version
    # Sync strategy: Upsert với field-level control
    # - INSERT lần đầu: Đẩy tất cả fields lên MySQL
    # - UPDATE sau đó: Chỉ update technical fields (firmware_version, os_version, last_seen, ip_address)
    # - KHÔNG overwrite: device_name, location (do Android app quản lý)
  
  mysql:
    host: "database-1.cba08ks48qdc.ap-southeast-1.rds.amazonaws.com"  # ✅ AWS RDS Endpoint
    port: 3306
    database: "iot_health_cloud"
    user: "pi_sync"  # ✅ Limited user (SELECT, INSERT, UPDATE only) - Principle of Least Privilege
    password_env: "MYSQL_CLOUD_PASSWORD"  # ✅ Sửa từ MYSQL_PI_SYNC_PASSWORD thành MYSQL_CLOUD_PASSWORD
    password: ""  # Or put password here (not recommended)
    
    # Connection pool settings
    pool_size: 5
    max_overflow: 10
    pool_timeout: 30
    pool_recycle: 3600  # Recycle connections after 1 hour
    
    # SSL/TLS (optional - recommended for production)
    ssl_enabled: false
    ssl_ca: "/path/to/ca-cert.pem"
    ssl_cert: "/path/to/client-cert.pem"
    ssl_key: "/path/to/client-key.pem"
  
  sync:
    mode: "auto"  # auto / manual / scheduled
    interval_seconds: 60  # Sync every 1 minute (auto mode)
    batch_size: 100  # Records per batch
    retry_attempts: 3
    retry_delay_seconds: 60
    
    # What to sync
    sync_health_records: true
    sync_alerts: true
    sync_calibrations: true
    sync_logs: false  # Logs create too much data
    sync_devices: true  # ✅ NEW: Sync device info
    sync_patients: true  # ✅ NEW: Sync patient info
    
    # Conflict resolution strategy
    conflict_strategy: "cloud_wins"  # cloud_wins / local_wins / manual

# ============================================================
# THRESHOLD MANAGEMENT (AI-Generated Personalized Thresholds)
# ============================================================
threshold_management:
  # Sync patient thresholds from cloud to local database
  sync_interval_seconds: 60  # Check for new thresholds every 60 seconds (1 minute)
  
  # Auto-reload thresholds when changed (recommended)
  auto_reload: true
  
  # Fallback to baseline thresholds if patient has no custom thresholds
  fallback_to_baseline: true
  
  # Baseline thresholds (used as fallback)
  baseline:
    heart_rate:
      min_critical: 40
      min_normal: 60
      max_normal: 100
      max_critical: 120
    spo2:
      min_critical: 85
      min_normal: 95
      max_normal: 100
      max_critical: 100
    systolic_bp:
      min_critical: 80
      min_normal: 90
      max_normal: 120
      max_critical: 180
    diastolic_bp:
      min_critical: 50
      min_normal: 60
      max_normal: 80
      max_critical: 120
    temperature:
      min_critical: 35.0
      min_normal: 36.1
      max_normal: 37.2
      max_critical: 39.0
  
database:
  backup_enabled: true
  backup_interval: 3600
  path: data/health_monitor.db
  type: sqlite
display:
  framebuffer: /dev/fb1
  resolution:
  - 480
  - 320
  rotation: 0
  size: '3.5'
  type: SPI_LCD
logging:
  backup_count: 5
  file: logs/health_monitor.log
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  level: INFO
  max_size: 10MB
# patient: REMOVED - patient_id is resolved from cloud database based on device_id
# Device-centric approach: Pi chỉ cần device_id, patient_id tự động resolve từ cloud
sensors:
  blood_pressure:
    enabled: true
    inflate_target_mmhg: 190
    deflate_rate_mmhg_s: 3.0
    max_pressure_mmhg: 200
    pump_gpio: 26
    valve_gpio: 16
    hx710b:
      enabled: true
      gpio_dout: 6
      gpio_sck: 5
      mode: 10sps
      read_timeout_ms: 500
      calibration:
        offset_counts: 1300885
        slope_mmhg_per_count: 3.529226775615232e-05 #3.5765743256e-05 
        adc_inverted: false
    algorithm:
      sample_rate: 10.0
      bandpass_low: 0.5
      bandpass_high: 5.0
      filter_order: 4
      sys_ratio: 0.55
      dia_ratio: 0.8
  max30102:
    adc_range: 4096
    buffer_size: 100
    enabled: true
    hardware_sample_rate: 100
    ir_threshold: 50000
    led_mode: 3
    max_samples_per_read: 24
    min_readings_for_calc: 50
    pulse_amplitude_ir: 127
    pulse_amplitude_red: 127
    sample_average: 1
    sample_rate: 5
  mlx90614:
    enabled: true
    i2c_address: 90
    i2c_bus: 1
    max_error_count: 5
    sample_rate: 0.5
    sensor_type: MLX90614
    smooth_factor: 0.1
    temperature_offset: 0.0
    use_object_temp: true
  hx710b:
    calibration:
      offset_counts: 1303339

# ============================================================
# NOTE: Static thresholds section đã REMOVED
# Thay vào đó sử dụng threshold_management.baseline (line 149)
# để quản lý tập trung tất cả threshold mặc định
# ============================================================

bp_advanced:
  control:
    inflate_target_mmhg: 165.0
    inflate_soft_limit_mmhg: 200.0
    inflate_timeout_s: 25.0
    inflate_grace_s: 1.5
    deflate_target_dpdt_mmhg_s: 3.0
    deflate_pwm_period_s: 0.5
    deflate_lut:
    - bin: 160
      duty: 60
    - bin: 140
      duty: 55
    - bin: 120
      duty: 52
    - bin: 100
      duty: 48
    - bin: 80
      duty: 45
    - bin: 60
      duty: 42
    - bin: 40
      duty: 40
    deflate_timeout_s: 90.0
    emergency_overpressure_mmhg: 200.0
    emergency_no_oscillation_s: 10.0
    emergency_sensor_timeout_s: 2.0
    emergency_dpdt_too_fast_mmhg_s: 8.0
    leak_max_drop_mmhg_per_min: 5.0
  signal:
    bpf_low_hz: 0.5
    bpf_high_hz: 5.0
    detrend_poly_order: 1
    envelope_method: hilbert
    map_search_window:
    - 0.3
    - 0.8
    min_valid_peaks_around_map: 5
    snr_min_db: 6.0
    hampel_window_s: 1.2
    hampel_k: 3.0
    min_samples_per_bin: 20
  estimate:
    sys_frac: 0.55
    dia_frac: 0.8
    map_weighted_centering: true
    quality_rules:
      reject_if_low_snr: true
      reject_if_few_peaks: true
