ai:
  anomaly_detection:
    algorithm: IsolationForest
    enabled: true
    sensitivity: 0.1
  chatbot:
    enabled: false
    model_path: models/health_chatbot.tflite
  trend_analysis:
    enabled: true
    window_size: 24
app:
  debug: true
  log_level: INFO
  name: IoT Health Monitor
  version: 1.0.0
audio:
  alert_sound: config/alert.wav
  enabled: true
  fallback_engine: espeak
  locale: vi
  piper:
    assets_dir: asset/tts
    config_path: /home/pi/piper_models/vi_VN-vais1000-medium.onnx.json
    model_path: /home/pi/piper_models/vi_VN-vais1000-medium.onnx
    speaker: ''
    strict_assets: true
  tts_engine: piper
  voice_enabled: true
  volume: 80
communication:
  mqtt:
    # Broker connection
    broker: test.mosquitto.org  # Public test broker (thay bằng broker thật khi deploy)
    port: 8883  # TLS port (1883 cho non-TLS)
    keepalive: 60
    
    # Authentication
    username: iot_health_device  # Thay bằng username thật
    password: ''  # Điền password vào đây hoặc dùng environment variable
    
    # Device identification
    device_id: rpi_bp_001  # Unique device ID
    
    # TLS/SSL Security
    use_tls: true
    ca_cert: config/certs/ca.crt  # Path đến CA certificate
    cert_file: config/certs/client.crt  # Client certificate (mutual TLS)
    key_file: config/certs/client.key  # Client private key
    
    # QoS levels per message type
    qos:
      vitals: 1  # At least once delivery
      alerts: 2  # Exactly once delivery (critical)
      status: 0  # Fire and forget
      commands: 2  # Exactly once delivery
    
    # Reconnection settings
    reconnect_delay: 5
    max_reconnect_attempts: 10
    
    # Last Will & Testament (offline detection)
    last_will:
      topic: iot_health/device/{device_id}/status
      message: '{"timestamp": {timestamp}, "device_id": "{device_id}", "status": "offline", "reason": "unexpected_disconnect"}'
      qos: 1
      retain: true
    
    # Topic templates (với placeholders)
    topics:
      vitals: iot_health/device/{device_id}/vitals
      alerts: iot_health/device/{device_id}/alerts
      status: iot_health/device/{device_id}/status
      commands: iot_health/patient/{patient_id}/commands
      predictions: iot_health/patient/{patient_id}/predictions
  
  rest_api:
    api_version: v1
    server_url: http://localhost:8000
    timeout: 5
    use_https: false
  
  store_forward:
    enabled: true
    max_queue_size: 1000
    max_retries: 5
    retry_interval: 30

# Cloud Synchronization (MySQL on Personal PC)
cloud:
  enabled: true  # ✅ ENABLED - Ready for cloud sync
  
  mysql:
    host: "192.168.2.15"  # ✅ UPDATED: Your PC IP address
    port: 3306
    database: "iot_health_cloud"
    user: "danhsidoi"  # ✅ UPDATED: Use working user
    password_env: "MYSQL_CLOUD_PASSWORD"  # Password from environment variable
    password: ""  # Or put password here (not recommended)
    
    # Connection pool settings
    pool_size: 5
    max_overflow: 10
    pool_timeout: 30
    pool_recycle: 3600  # Recycle connections after 1 hour
    
    # SSL/TLS (optional - recommended for production)
    ssl_enabled: false
    ssl_ca: "/path/to/ca-cert.pem"
    ssl_cert: "/path/to/client-cert.pem"
    ssl_key: "/path/to/client-key.pem"
  
  sync:
    mode: "auto"  # auto / manual / scheduled
    interval_seconds: 300  # Sync every 5 minutes (auto mode)
    batch_size: 100  # Records per batch
    retry_attempts: 3
    retry_delay_seconds: 60
    
    # What to sync
    sync_health_records: true
    sync_alerts: true
    sync_calibrations: true
    sync_logs: false  # Logs create too much data
    
    # Conflict resolution strategy
    conflict_strategy: "cloud_wins"  # cloud_wins / local_wins / manual
  
  device:
    device_id: "rasp_pi_001"  # ⚠️ Unique device identifier (keep unique per device)
    device_name: "Living Room Monitor"  # ⚠️ Give it a friendly name
    location: "Home - Living Room"  # ⚠️ Physical location

database:
  backup_enabled: true
  backup_interval: 3600
  path: data/health_monitor.db
  type: sqlite
display:
  framebuffer: /dev/fb1
  resolution:
  - 480
  - 320
  rotation: 0
  size: '3.5'
  type: SPI_LCD
logging:
  backup_count: 5
  file: logs/health_monitor.log
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  level: INFO
  max_size: 10MB
patient:
  age: 65
  gender: M
  id: patient_001
  name: Default Patient
sensors:
  blood_pressure:
    enabled: true
    inflate_target_mmhg: 190
    deflate_rate_mmhg_s: 3.0
    max_pressure_mmhg: 200
    pump_gpio: 26
    valve_gpio: 16
    hx710b:
      enabled: true
      gpio_dout: 6
      gpio_sck: 5
      mode: 10sps
      read_timeout_ms: 500
      calibration:
        offset_counts: 1300885
        slope_mmhg_per_count: 3.529226775615232e-05 #3.5765743256e-05 
        adc_inverted: false
    algorithm:
      sample_rate: 10.0
      bandpass_low: 0.5
      bandpass_high: 5.0
      filter_order: 4
      sys_ratio: 0.55
      dia_ratio: 0.8
  max30102:
    adc_range: 4096
    buffer_size: 100
    enabled: true
    hardware_sample_rate: 50
    ir_threshold: 50000
    led_mode: 3
    max_samples_per_read: 16
    min_readings_for_calc: 50
    pulse_amplitude_ir: 127
    pulse_amplitude_red: 127
    sample_average: 4
    sample_rate: 5
  mlx90614:
    enabled: true
    i2c_address: 90
    i2c_bus: 1
    max_error_count: 5
    sample_rate: 0.5
    sensor_type: MLX90614
    smooth_factor: 0.1
    temperature_offset: 0.0
    use_object_temp: true
  hx710b:
    calibration:
      offset_counts: 1303339
thresholds:
  blood_pressure:
    diastolic_critical: 110
    diastolic_max: 90
    systolic_critical: 180
    systolic_max: 140
  heart_rate:
    critical_max: 150
    critical_min: 40
    max: 100
    min: 60
  spo2:
    critical_min: 90
    min: 95
  temperature:
    critical_max: 39.0
    critical_min: 35.0
    max: 37.5
    min: 36.0
bp_advanced:
  control:
    inflate_target_mmhg: 165.0
    inflate_soft_limit_mmhg: 200.0
    inflate_timeout_s: 25.0
    inflate_grace_s: 1.5
    deflate_target_dpdt_mmhg_s: 3.0
    deflate_pwm_period_s: 0.5
    deflate_lut:
    - bin: 160
      duty: 60
    - bin: 140
      duty: 55
    - bin: 120
      duty: 52
    - bin: 100
      duty: 48
    - bin: 80
      duty: 45
    - bin: 60
      duty: 42
    - bin: 40
      duty: 40
    deflate_timeout_s: 90.0
    emergency_overpressure_mmhg: 200.0
    emergency_no_oscillation_s: 10.0
    emergency_sensor_timeout_s: 2.0
    emergency_dpdt_too_fast_mmhg_s: 8.0
    leak_max_drop_mmhg_per_min: 5.0
  signal:
    bpf_low_hz: 0.5
    bpf_high_hz: 5.0
    detrend_poly_order: 1
    envelope_method: hilbert
    map_search_window:
    - 0.3
    - 0.8
    min_valid_peaks_around_map: 5
    snr_min_db: 6.0
    hampel_window_s: 1.2
    hampel_k: 3.0
    min_samples_per_bin: 20
  estimate:
    sys_frac: 0.55
    dia_frac: 0.8
    map_weighted_centering: true
    quality_rules:
      reject_if_low_snr: true
      reject_if_few_peaks: true
