ai:
  anomaly_detection:
    algorithm: IsolationForest
    enabled: true
    sensitivity: 0.1
  chatbot:
    enabled: false
    model_path: models/health_chatbot.tflite
  trend_analysis:
    enabled: true
    window_size: 24
app:
  debug: true
  # ============================================================
  # Emergency Button Configuration (Active-Low)
  # ============================================================
  # Hardware: Button connects GPIO pin to GND when pressed
  # - Nh·∫£ (RELEASED): GPIO = HIGH (1) - pulled up by internal pull-up
  # - Nh·∫•n (PRESSED):  GPIO = LOW  (0) - connected to GND
  # 
  # GPIO Setup in main_app.py:
  # - GPIO.PUD_UP: Enable internal pull-up (k√©o HIGH)
  # - GPIO.FALLING: Detect on falling edge (HIGH ‚Üí LOW transition)
  # - bouncetime: 300ms debounce (anti-chatter)
  # ============================================================
  emergency_button_gpio: 23  # BCM GPIO 23 (Pin 16 on Raspberry Pi)
  log_level: INFO
  name: IoT Health Monitor
  version: 1.0.0
audio:
  alert_sound: config/alert.wav
  enabled: true
  fallback_engine: espeak
  locale: vi
  piper:
    assets_dir: asset/tts
    config_path: /home/pi/piper_models/vi_VN-vais1000-medium.onnx.json
    model_path: /home/pi/piper_models/vi_VN-vais1000-medium.onnx
    speaker: ''
    strict_assets: true
  tts_engine: piper
  voice_enabled: true
  volume: 80
communication:
  mqtt:
    # ============================================================
    # HiveMQ Cloud Broker (Production)
    # ============================================================
    broker: c8c0b20138314154b4f21f4c7d1e19a5.s1.eu.hivemq.cloud
    port: 8883  # TLS port (b·∫Øt bu·ªôc cho HiveMQ Cloud)
    websocket_port: 8884  # WebSocket port (cho web dashboard)
    keepalive: 60
    
    # Authentication (HiveMQ Cloud credentials)
    username: rpi_bp_001  # HiveMQ username cho Pi
    password_env: MQTT_PASSWORD  # Password t·ª´ environment variable (.env)
    password: ''  # KH√îNG ƒëi·ªÅn password tr·ª±c ti·∫øp v√†o ƒë√¢y
    
    # Device identification
    device_id: rpi_bp_001  # Unique device ID
    
    # TLS/SSL Security (HiveMQ Cloud m·∫∑c ƒë·ªãnh d√πng TLS)
    use_tls: true
    # HiveMQ Cloud d√πng Let's Encrypt CA (trusted by default)
    # Kh√¥ng c·∫ßn cert files ri√™ng, Python ssl module t·ª± verify
    
    # QoS levels per message type
    qos:
      vitals: 1  # At least once delivery
      alerts: 2  # Exactly once delivery (critical)
      status: 0  # Fire and forget
      commands: 2  # Exactly once delivery
    
    # Reconnection settings
    reconnect_delay: 5
    max_reconnect_attempts: 10
    
    # Last Will & Testament (offline detection)
    last_will:
      topic: iot_health/device/{device_id}/status
      message: '{"device_id": "{device_id}", "status": "offline", "reason": "unexpected_disconnect"}'
      qos: 1
      retain: true
    
    # Topic templates (v·ªõi placeholders)
    topics:
      vitals: iot_health/device/{device_id}/vitals
      alerts: iot_health/device/{device_id}/alerts
      status: iot_health/device/{device_id}/status
      commands: iot_health/patient/{patient_id}/commands
      predictions: iot_health/patient/{patient_id}/predictions
  
  rest_api:
    api_version: v1
    server_url: http://localhost:8000
    timeout: 5
    use_https: false
  
  store_forward:
    enabled: true
    max_queue_size: 1000
    max_retries: 5
    retry_interval: 30

# Cloud Synchronization (AWS RDS MySQL - Singapore)
cloud:
  enabled: true  # ‚úÖ ENABLED - Syncing to AWS RDS
  
  # Device registration (for cloud database)
  device:
    device_id: "rpi_bp_001"  # ‚úÖ Unique device identifier (IMPORTANT: Change per device)
    device_name: "Living Room Health Monitor"  # Human-readable name (s·∫Ω b·ªã overwrite b·ªüi Android app)
    device_type: "blood_pressure_monitor"  # Device type
    location: "Home - Living Room"  # Physical location (s·∫Ω b·ªã overwrite b·ªüi Android app)
    pairing_code: "ABC123XY"  # ‚úÖ Pairing code c·ªë ƒë·ªãnh cho thi·∫øt b·ªã n√†y (d√πng ƒë·ªÉ pair v·ªõi Android app)
    firmware_version: "1.0.0"  # Update when firmware changes
    os_version: "Raspberry Pi OS Bookworm 64-bit"  # OS version
    # Sync strategy: Upsert v·ªõi field-level control
    # - INSERT l·∫ßn ƒë·∫ßu: ƒê·∫©y t·∫•t c·∫£ fields l√™n MySQL
    # - UPDATE sau ƒë√≥: Ch·ªâ update technical fields (firmware_version, os_version, last_seen, ip_address)
    # - KH√îNG overwrite: device_name, location (do Android app qu·∫£n l√Ω)
  
  mysql:
    host: "database-1.cba08ks48qdc.ap-southeast-1.rds.amazonaws.com"  # ‚úÖ AWS RDS Endpoint
    port: 3306
    database: "iot_health_cloud"
    user: "pi_sync"  # ‚úÖ Limited user (SELECT, INSERT, UPDATE only) - Principle of Least Privilege
    password_env: "MYSQL_CLOUD_PASSWORD"  # ‚úÖ S·ª≠a t·ª´ MYSQL_PI_SYNC_PASSWORD th√†nh MYSQL_CLOUD_PASSWORD
    password: ""  # Or put password here (not recommended)
    
    # Connection pool settings
    pool_size: 5
    max_overflow: 10
    pool_timeout: 30
    pool_recycle: 3600  # Recycle connections after 1 hour
    
    # SSL/TLS (optional - recommended for production)
    ssl_enabled: false
    ssl_ca: "/path/to/ca-cert.pem"
    ssl_cert: "/path/to/client-cert.pem"
    ssl_key: "/path/to/client-key.pem"
  
  sync:
    mode: "auto"  # auto / manual / scheduled
    interval_seconds: 60  # Sync every 1 minute (auto mode)
    batch_size: 100  # Records per batch
    retry_attempts: 3
    retry_delay_seconds: 60
    
    # What to sync
    sync_health_records: true
    sync_alerts: true
    sync_calibrations: true
    sync_logs: false  # Logs create too much data
    sync_devices: true  # ‚úÖ NEW: Sync device info
    sync_patients: true  # ‚úÖ NEW: Sync patient info
    
    # Conflict resolution strategy
    conflict_strategy: "cloud_wins"  # cloud_wins / local_wins / manual

# ============================================================
# THRESHOLD MANAGEMENT (AI-Generated Personalized Thresholds)
# ============================================================
threshold_management:
  # Sync patient thresholds from cloud to local database
  sync_interval_seconds: 60  # Check for new thresholds every 60 seconds (1 minute)
  
  # Auto-reload thresholds when changed (recommended)
  auto_reload: true
  
  # Fallback to baseline thresholds if patient has no custom thresholds
  fallback_to_baseline: true
  
  # Baseline thresholds (used as fallback)
  baseline:
    heart_rate:
      min_critical: 40
      min_normal: 60
      max_normal: 100
      max_critical: 120
    spo2:
      min_critical: 85
      min_normal: 95
      max_normal: 100
      max_critical: 100
    systolic_bp:
      min_critical: 80
      min_normal: 90
      max_normal: 120
      max_critical: 180
    diastolic_bp:
      min_critical: 50
      min_normal: 60
      max_normal: 80
      max_critical: 120
    temperature:
      min_critical: 35.0
      min_normal: 36.1
      max_normal: 37.2
      max_critical: 39.0
  
database:
  backup_enabled: true
  backup_interval: 3600
  path: data/health_monitor.db
  type: sqlite
display:
  framebuffer: /dev/fb1
  resolution:
  - 480
  - 320
  rotation: 0
  size: '3.5'
  type: SPI_LCD
logging:
  backup_count: 5
  file: logs/health_monitor.log
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  level: INFO
  max_size: 10MB
# patient: REMOVED - patient_id is resolved from cloud database based on device_id
# Device-centric approach: Pi ch·ªâ c·∫ßn device_id, patient_id t·ª± ƒë·ªông resolve t·ª´ cloud
sensors:
  blood_pressure:
    enabled: true
    inflate_target_mmhg: 190  # Reduced from 200 to avoid ADC saturation (offset too high)
    deflate_rate_mmhg_s: 3.0
    max_pressure_mmhg: 200
    pump_gpio: 26
    valve_gpio: 20
    hx710b:
      enabled: true
      gpio_dout: 6
      gpio_sck: 5
      mode: 10sps
      read_timeout_ms: 500
      calibration:
        offset_counts: 1056334  # Updated from connection-quality test (100 samples, std~460)
        slope_mmhg_per_count: 1.9238166197e-06  # TEMPORARY: adjust after bp_calib_tool.py
        adc_inverted: false  # HX710B output not inverted
    algorithm:
      sample_rate: 10.0
      bandpass_low: 0.5
      bandpass_high: 5.0
      filter_order: 4
      sys_ratio: 0.55
      dia_ratio: 0.8
  max30102:
    adc_range: 4096
    buffer_size: 100
    enabled: true
    hardware_sample_rate: 100
    ir_threshold: 50000
    led_mode: 3
    max_samples_per_read: 24
    min_readings_for_calc: 50
    pulse_amplitude_ir: 115    # üîß OPTIMIZE: IR LED 100‚Üí115 (~18mA)
                                # 100 qu√° th·∫•p ‚Üí IR_PI dao ƒë·ªông, RED baseline unstable
                                # 115 = sweet spot gi·ªØa 100 v√† 127
    pulse_amplitude_red: 255   # üîß MAX: RED LED 50mA (gi·ªØ nguy√™n)
                                # RED_AC OK khi ·ªïn ƒë·ªãnh, nh∆∞ng c·∫ßn warm-up
    sample_average: 1
    sample_rate: 5
    
    # ============================================================
    # SpO2 Calibration Coefficients (Two-Point Calibration)
    # ============================================================
    # Formula: SpO2 = intercept + slope √ó R
    # where R = (AC_red/DC_red) / (AC_ir/DC_ir)
    # 
    # Default: Maxim generic formula (SpO2 = 110 - 25*R)
    # For custom calibration:
    #   1. Measure R1, R2 with reference oximeter showing SpO2_1, SpO2_2
    #   2. Calculate: slope = (SpO2_2 - SpO2_1) / (R2 - R1)
    #   3. Calculate: intercept = SpO2_1 - slope √ó R1
    # ============================================================
    spo2_calibration:
      intercept: 110.0    # A coefficient (default Maxim)
      slope: -25.0        # B coefficient (default Maxim)
      use_calibration: true  # Set false to use piecewise fallback
      valid_r_min: 0.4    # Minimum valid R-value
      valid_r_max: 1.8    # Maximum valid R-value
      
      # Calibration metadata (optional - for tracking)
      calibration_date: ""  # YYYY-MM-DD when calibrated
      reference_device: ""  # e.g., "Nonin Onyx II 9560"
      calibration_points: []  # List of {r, spo2} pairs
  mlx90614:
    enabled: true
    i2c_address: 90
    i2c_bus: 1
    max_error_count: 5
    sample_rate: 2.0  # Increased from 0.5 to 2 Hz for better sampling
    sensor_type: MLX90614
    smooth_factor: 0.2  # Increased from 0.1 for better noise filtering
    temperature_offset: 2.5  # Typical forehead offset (will calibrate later)
    use_object_temp: true
    # Note: Forehead temperature is typically 1.5-3¬∞C lower than core body temp
    # Common offset range: +2.0 to +3.0¬∞C (adjust after proper calibration)
  hx710b:
    calibration:
      offset_counts: 1303339

# ============================================================
# NOTE: Static thresholds section 
# ƒë·ªÉ qu·∫£n l√Ω t·∫≠p trung t·∫•t c·∫£ threshold m·∫∑c ƒë·ªãnh
# ============================================================

bp_advanced:
  control:
    inflate_target_mmhg: 190.0
    inflate_soft_limit_mmhg: 200.0
    inflate_timeout_s: 25.0
    inflate_grace_s: 1.5
    deflate_target_dpdt_mmhg_s: 3.0
    deflate_pwm_period_s: 0.5
    deflate_lut:
    - bin: 160
      duty: 60
    - bin: 140
      duty: 55
    - bin: 120
      duty: 52
    - bin: 100
      duty: 48
    - bin: 80
      duty: 45
    - bin: 60
      duty: 42
    - bin: 40
      duty: 40
    deflate_timeout_s: 90.0
    emergency_overpressure_mmhg: 200.0
    emergency_no_oscillation_s: 10.0
    emergency_sensor_timeout_s: 2.0
    emergency_dpdt_too_fast_mmhg_s: 8.0
    leak_max_drop_mmhg_per_min: 5.0
  signal:
    bpf_low_hz: 0.5
    bpf_high_hz: 5.0
    detrend_poly_order: 1
    envelope_method: hilbert
    map_search_window:
    - 0.3
    - 0.8
    min_valid_peaks_around_map: 5
    snr_min_db: 6.0
    hampel_window_s: 1.2
    hampel_k: 3.0
    min_samples_per_bin: 20
  estimate:
    sys_frac: 0.55
    dia_frac: 0.8
    map_weighted_centering: true
    quality_rules:
      reject_if_low_snr: true
      reject_if_few_peaks: true
